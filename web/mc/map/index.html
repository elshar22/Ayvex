<html>
<head>
<title>Ayvex Light Industries<br>multidimensional viewer</title>

<!-- script src="jquery-1.10.2.min.js"></script   todo   -->
<script src="../../lib/jquery-1.10.2.js"></script>
<script src="../../lib/pre3d.js"></script>
<script src="../../lib/queryParams.js"></script>
<script src="demoUtils.js"></script>
<script src="cameraAndStuff.js"></script>
<script src="mc2data.js"></script>
<script src="memoize.js"></script>
<script src="stepper.js"></script>
<script src="tree.js"></script>
<script src="hasher.js"></script>
<script src="loadDataFile.js"></script>
<script src="localSettings.js"></script>
<script src="DataPoint.js"></script>
<script src="Gamer.js"></script>
</head>

<body>


<table border="0" height="90%">
<tr>
<td style="width:800px" oncontextmenu=";return false"> <!-- disallowing context menu in the map surface only! -->
<canvas width="800" height="600" id="c" 
	style="border:2px solid #0000DD;background-color:beige;"
	
/>
</td>
<td valign="top">
<span style="font-family:Arial">
<h6>Copyright 2014 -- Ayvex Light Industries</h6>
<br><br>
pick dataset: 
<select id="dataset">
  <option value="mc2map">mc2 world map</option>
  <option value="frcWld">fractals</option>
  <option value="hiiDimAnlErq">erquake</option>
  <option value="hiiDimAnlFlw">flower</option>
</select>
<br><br><br>
<span  style="font-family:Arial;font-size:12">
<div style="border:2px solid #000000;background-color:lightGray" id="controlPanel">
<input type="button" id="flyTo" value="flyTo"/>

<input type="checkbox" value="animate" id="animate" checked>ANM</input>
xMOD:<select id="xanimate">
	<option value="none">none</option>
	<option value="sequence">sequence</option>
</select>
<input type="checkbox" value="lockon" id="lockon" >LCK</input>
<input type="checkbox" value="black" id="black" checked>BLK</input>
<input type="checkbox" value="big" id="big" >BIG</input>
</span><br>
tags:<input type="text"/>   <!-- value="<all>" id="tags" style="color:red"/> -->
</span>
</div>
<br><div id="readout" style="background-color:yellow">
<table>
<tr><td colspan="2">readout</td>
<tr style="font-family:Arial;font-size:12">
<td>
frame<input type="text" id="frameNum" value="x"/><br>
camX<input type="text" id="camX" value="x"/><br>
camY<input type="text" id="camY" value="x"/><br>
camZ<input type="text" id="camZ" value="x"/><br>
</td>
<td>
<br>
camRotX<input type="text" id="camRotX" value="x"/><br>
camRotY<input type="text" id="camRotY" value="x"/><br>
camRotZ<input type="text" id="camRotZ" value="x"/><br>
</td>
</tr>
</table>
<br>
</div>
<div><br><br><br><br><br><br><br><br><br>
</div>

<div id="toolbar" style="position: relative; bottom: 0; left: 0; border:1px solid #000000; padding:10px; spacing:10px"> </div>
</td>
<!--position: absolute; bottom: 0;-->

</tr>
</table>
---


<script>



var floor=62;  //minecraftWaterLevel bugbug setting or ???

var toolbar = document.getElementById("toolbar");
var theDrawings=[];



function debugAdd(s)
{
	toolbar.innerHTML+=s+'<br/>';
}

function debugSet(s)
{
	toolbar.innerHTML=s;
}


function definedAndTrue(val)
{
	if (typeof val == 'undefined') return false;
	return val;
}

function pushAll(ofThese,intoThese)  //bugbug why did a.extend(b)  not work???
{
	for(var ii=0,il=ofThese.length; ii<il; ii++)
	{
		intoThese.push(ofThese[ii]);
	}
}

//each step needs to be set off by the step before it, but on different thread to account for dynamic code
//function doAllSteps(arrSteps)
//{
//	doSteps(arrSteps,0);
//}
//
//var stepLimit = 20;  //bugbug const or passed into doAllSteps() ???
//function doSteps(arrSteps,whereAt)
//{
//	if (whereAt>=arrSteps.length) return;
//	if (whereAt>stepLimit)
//	{
//		alert("doSteps limit passed errCode333kz");
//		return;
//	}
//	var thisStep = arrSteps[whereAt];
//	if (thisStep==null) return;
//	var thisStepType = typeof thisStep;
//	if (thisStepType=='function')
//	{
//		doStep(function(){ arrSteps[whereAt](); doSteps(arrSteps,whereAt+1); });
//	}
//	else if (thisStepType=='array')
//	{
//		var command = thisStep[0];
//		switch(command)
//		{
//			case "waiton": doStep(function()
//									{ 
//										if (thisStep[1]())
//											doSteps(arrSteps,whereAt+1);
//										else
//											doSteps(arrSteps,whereAt);
//									 
//									}); 
//				break;
//			default: alert('how did we get here bugbug323wj');
//		}
//	}
//}
//
//function doStep(step)
//{
//	setTimeout(step,100);
//}
////bugbug needed??
//

//this works, but the script won't be live until you yield the thread for a while.  call it carefully!
function addScript(filename)
{
	//http://www.javascriptkit.com/javatutors/loadjavascriptcss.shtml  
	var newScriptTag=document.createElement('script')
	newScriptTag.setAttribute("type","text/javascript")
	newScriptTag.setAttribute("src", filename)
	document.getElementsByTagName("head")[0].appendChild(newScriptTag);
}	

function makeBigMap(data)
{
	var path;
	var jj=0;  //for the inner loop inside one path
	var kk=0;  //index into the outputs
	for(var ii=0, limit=data.length; ii<limit; ++ii)  
	{
		pt=data[ii];
		if (ii==0 || pt[3]!='') //there is text so start a new path
		{
			if (path) //store the old path if there is one
			{
				theDrawings[kk++]=path;
			}
			path = new Pre3d.Path();
			path.starting_point = 0;  //we make this standard
			path.points = [ ];  
			path.curves = [ ];
			jj=0;
		}
		
		//debugAdd(ii);
		var pt = data[ii];
		path.points[jj]={x:pt[0],y:pt[1],z:pt[2],t:pt[3]};   
		path.curves[jj]=new Pre3d.Curve(jj,jj,jj);
		path.color='brown';
		path.width=2;
		jj++;
	}
	
	theDrawings.push(path);  //close it out
}

function addTreesAndWater(paths)
{
	landmarkSpacing=200;  //bugbug consts throughout
	abs=Math.abs;
	for(var xx=-20000; xx<20000; xx+=landmarkSpacing)
	{
		for(var zz=-20000; zz<20000; zz+=landmarkSpacing)
		{
			var d=abs(xx)+abs(zz) + 5;
			var h8=Hasher.consistentHash(['tree',xx,zz])%256;
			if (hRndN(d,h8)<80)   paths.push(new Tree(xx,floor,zz,'calculate'));
			if (hRndN(d,h8)<200)   paths.push(waterMarker(xx+hRndN(500,h8),zz+hRndN(500,h8)));  //bugbug
		}
	}
	return paths;
}


function addMarkersAndWater(paths)
{
	landmarkSpacing=200;  //bugbug consts throughout
	abs=Math.abs;
	for(var xx=-20000; xx<20000; xx+=landmarkSpacing)
	{
		for(var zz=-20000; zz<20000; zz+=landmarkSpacing)
		{
			var d=abs(xx)+abs(zz);
			if (d>1000 && d<4000 && badRnd(d)<800)   paths.push(marker(xx,zz));
			if (d>2000 && badRnd(d)<2000)            paths.push(waterMarker(xx+badRnd(500),zz+badRnd(500)));
		}
	}
	return paths;
}

function addCoordinateVectors(paths)
{
	//coordinate vectors		
	paths.push(infoLine( 	{x:1000,y:0,z:0,t:'X'},
							{x:0   ,y:0,z:0}        ));
							
	paths.push(infoLine( 	{x:0,y:1000,z:0,t:'Y'},
							{x:0,y:0   ,z:0}          ));
							
	paths.push(infoLine(	{x:0,y:0,z:1000,t:'Z'},  //and Z should be south
							{x:0,y:0,z:0   } ));
	
}

 
 
 function waterMarker(xx,zz, waveHeight, waveLength)
 {
	if (waveHeight===undefined) waveHeight=badRnd(8)-4;
	if (waveLength===undefined) waveLength=badRnd(7)+13;
	return twoSegmentPath(	'blue',
							1,
							xx,62,zz,
							xx,64+waveHeight,zz+waveLength/3,
							xx,62,zz+waveLength
						); 
 }
 
 //function markerOrTree(xx,zz, treePoleFrac)
 function marker(xx,zz)
 {
	var height=40;

	return twoSegmentPath( contrastBackground(),
							  1,
							  xx, floor, zz,   
							  xx, height+floor, zz,
							  xx, height+floor, zz-10);  //minus Z is north

 }
 
 function contrastBackground()
 {
	if (mainBgColor=='white') return 'black';
	if (mainBgColor=='black') return 'white';
	return 'cyan'; //bugbug
 }


 function contrast(color)
 {
	return 'green';
	if (mainBgColor=='black' && color=='black') return 'white';
	return color;
 }
 
 function infoLine(ptA,ptB)
 {
	return linePath(	
						'6666FF',
						0.1,
						ptA,
						ptB
					);
							
 }
 
 
function linePath(color,width,ptA,ptB)  //ptA includes a text .t  
{
	var path=new Pre3d.Path();
	path.starting_point=0;
	path.points[0]=ptA;
	path.points[1]=ptB;
	path.curves[0]=new Pre3d.Curve(1,1,1);  //to make it a line, everything looks at 0th point.
	path.color=color;
	path.width=width;
	return path;
}


//bugbug move some of this to its own file
 function twoSegmentPath(color,width,x1,y1,z1,x2,y2,z2,x3,y3,z3)
 {
	var path=new Pre3d.Path();
	path.starting_point=0;
	path.points[0]={x:x1,y:y1,z:z1,t:""};  //""+x1+","+y1
	path.points[1]={x:x2,y:y2,z:z2,t:""	};
	path.points[2]={x:x3,y:y3,z:z3,t:""  };
	path.curves[0]=new Pre3d.Curve(1,1,1);  //to make it a line, everything looks at 0th point.
	path.curves[1]=new Pre3d.Curve(2,2,2);  //to make it a line, everything looks at 0th point.
	path.color=color;
	path.width=width;
	return path;
 }
 
function makeFakeMap()
{
	var p0={x:0,y:15,z:20};    var t0='baseCamp';
	var p1={x:50,y:-15,z:30};  var t1='end of the line';
	var path = new Pre3d.Path();
    path.points = 
	  [
		  {x: p0.x, y: p0.y, z: p0.z, t:'this one path'},
		  {x: p1.x, y: p1.y, z: p1.z, t:''},
		  {x: 45, y:45, z:45, t:''}
	  ];
    path.curves = [new Pre3d.Curve(0, 0, 0), new Pre3d.Curve(1,1,1), new Pre3d.Curve(2,2,2)];
    path.starting_point = 0;
	path.color=contrastBackground();
    return [path];
}



function setMap(dataSetName)  //no longer a callback from the cameraAndStuff.js  
{
	//defaulting a bunch
	if (typeof dataSetName === 'undefined')
	{
		dataSetName=$("#dataset").value
		if (typeof dataSetName === 'undefined')
		{
			dataSetName='mc2map';
		}
	}
	
	switch(dataSetName)
	{
		case 'mc2map': setMc2Map(); break;
		case 'frcWld': setFractalWorldMap();  break;   		//bugbug semantics "map" for these entities is wrong....it's a full presentation around a dataset, the framing around the map, etc.
		case 'hiiDimAnlErq': setEarthquakeMap(); break;
		case 'hiiDimAnlFlw': setFlowersMap(); break;
		default: setErrorMap(dataSetName); break;
	}
	
}

function changeHiDim(newMode)
{
	DemoUtils.Notify("changeHiDim",matrixForMode(newMode));
}

function changeXanimate(ev)
{
	var newMode=ev.target.value;
	ev.stopPropagation(); //bugbug needed?
	changeHiDim(newMode);
}

function changeDataSet(ev)
{
	//bugbug find a better way to do this without refreshing...just an event to the camera or something....new call to start3d?
	var newDataSetName=ev.target.value;
	ev.stopPropagation();  //bugbug needed??
	window.location.href="?dataset="+newDataSetName;
}

function setErrorMap(dataSetName)
{
	debugSet("bugbug setErrorMap is nyi:"+dataSetName);
}

function setMc2Map()
{
	var rawData=getMc2Data();
	makeBigMap(rawData);
	addMarkersAndWater(theDrawings);
	addCoordinateVectors(theDrawings);
}

function setFractalWorldMap()
{
	var treePoleFrac=0.5;
	addCoordinateVectors(theDrawings);
	//todo add perlin noise, etc etc etc
	addTreesAndWater(theDrawings,treePoleFrac);
	addGamer(theDrawings,"bob",62,62,62);
	
}

function addGamer(theDrawings,name,x,y,z)
{
	var gamer= new Gamer();
	gamer.moveTo(x,y,z);
	gamer.name('bob');
	theDrawings.push(gamer);
}


function setEarthquakeMap()
{	
	var filename="data/erq_all_month.js";
	
	//todo should go into extended CSV script file thingy, not here with 
	var columnInfo=
	[  //time,latitude,longitude,depth,mag,magType,nst,gap,dmin,rms,net,id,updated,place,type
		{name:'time',readas:'utc',scale:0.000001,offset:1.387e+12},  //todo what are the other columns about a column??  (isUTC, parseThisWay, limits, precision, short and long name
		{name:'lat',readas:'float',scale:10,offset:0}, 
		{name:'long',readas:'float',scale:10,offset:0},
		{name:'depth',readas:'float',scale:1,offset:0},
		///////there are more columns....pull them in to make the demo better (need more dimensions)
	];

	//todo maybe this too into some kinda extended datafile format
	var dataFileOptions={
							'skipFirstLine':1,
							'skipLinesWithFirstCharIn':'#'
						};
	
	addScript(filename);
	
		
	var stuffToDo=StepperModule.Stepper.Create([  //bugbug should be .then()???;
			// function() {addScript(filename);}.bind(this) //so that data set is fetchable, must be in other thread for the script to activate
			['waiton',function(){ return (definedAndTrue(earthquakeDataLoaded)); }]
			,function() {parseDataSet(dataFileOptions,columnInfo);}.bind(this)
			,function() {theDrawings.push(DataPoint.FromArr([-2000,100,100],"stand here to start")); }.bind(this)
			,function() {
							DemoUtils.Notify('moveCamera',{
								rotate_x: rad(3),
								rotate_y: rad(90),
								rotate_z: rad(0),
								x: 800,
								y: -650,
								z: 1100});  //bugbug magic numbers.
							
							//changeHiDim('sequence');  //bugbug can we do this through the UI to reflect the initial state correctly??  bugbug not checkin ready							
							$("#xanimate").val('sequence').change();
						}.bind(this)	
		]);
	stuffToDo.run()
}


function setFlowersMap()
{
	var shortBaseUrl = "http://localhost:5984/cosmos";  //bugbug where to get this from??
	var flowerUrl = shortBaseUrl+"/iris.json";  
	

	var dataToSendWithRequest = ''
	var reqHandler = $.getJSON( flowerUrl, 
								dataToSendWithRequest, 
								setFlowersMapStep2)  // on success, run this next function
		//.done(function() {
		//	//alert( "second success" );
		//})
		.fail(function() {
			alert( "error" +reqHandler.error);
		})
		//.always(function() {
		//	//alert( "finishedbugbug258y" );
		//})
	;
		 
	function setFlowersMapStep2(jsonData)
	{
		var columnInfo=
		[ 
			{name:'x',readas:'float',scale:100,offset:200},  //todo what are the other columns about a column??  (isUTC, parseThisWay, limits, precision, short and long name
			{name:'y',readas:'float',scale:100,offset:200}, 
			{name:'z',readas:'float',scale:100,offset:200},
			{name:'q',readas:'float',scale:10,offset:0}
		];
	
		theDrawings=[];
		addCoordinateVectors(theDrawings);
		
		var theNewPoints = jsonData.docs.map(function(onePointJson) {
												scaleJson(onePointJson,columnInfo);
												return DataPoint.FromJson(onePointJson);
											}); 
		pushAll(theNewPoints,theDrawings);
		
		DemoUtils.Notify( 'moveCamera',{  //bugbug wish i could say 'pointAt' instead
			rotate_x: rad(0),
			rotate_y: rad(283),
			rotate_z: rad(0),
			x: 17000,
			y: 20000,
			z: 19000});  //bugbug magic numbers.  bugbug negated?
	}
	
	

	function scaleJson(onePointJson,columnInfo)
	{
		onePointJson.x = convertAndScale(columnInfo[0],onePointJson.x);
		onePointJson.y = convertAndScale(columnInfo[1],onePointJson.y);
		onePointJson.z = convertAndScale(columnInfo[2],onePointJson.z);
		
		for(var ii=0,il=columnInfo.length; ii<il; ii++)
		{
			onePointJson.xd[ii] = convertAndScale(columnInfo[ii],onePointJson.xd[ii]);
		}
	}


}

	//changeHiDim('sequence');  //bugbug can we do this through the UI to reflect the initial state correctly??  bugbug not checkin ready							
//							$("#xanimate").val('sequence').change();
		//turn the json data into DataPoints
	//	var steps=StepperModule.Stepper.Create([  //bugbug should be .then()???;
			// function() {addScript(filename);}.bind(this) //so that data set is fetchable, must be in other thread for the script to activate
			//['waiton',function(){ return (bugbugblahblahDataLoaded==1); }]
			//,function() {parseDataSet(dataFileOptions,columnInfo);}.bind(this)
			//function() {theDrawings.push(DataPoint.From([200,100,100],"bugbug is this thing on?")); }.bind(this)
			//,function() {
				//			DemoUtils.Notify('moveCamera',{
				//				rotate_x: rad(3),
				//				rotate_y: rad(90),
				//				rotate_z: rad(0),
				//				x: 700,
				//				y: -550,
				//				z: 1000});  //bugbug magic numbers.
							
							//changeHiDim('sequence');  //bugbug can we do this through the UI to reflect the initial state correctly??  bugbug not checkin ready							
				//			$("#xanimate").val('sequence').change();
				//		}.bind(this)	
		//]);
		//steps.run()
			
	
	//might need this elsewhere bugbug 
	// Set another completion function for the request above
	//reqHandler.always(function() {
	//	alert( "second finished" );
	//});

		
	
	
	//old needed??? bugbug jquery fetch the string
	//$.get(flowerUrl, function(data) {
	//	alert("foo526"+data);	
	//	debugSet(data);
	//}).then(function(){alert("foo");});
	
	//retrieve as couchDB data set here???  //bugbug you are here
	
	



function matrixForMode(hiDimMode)
{
	switch(hiDimMode)
	{

		case 'sequence':
			return [
						[0,0,0,0],  //bugbug need helper to create this only giving 0,4,1
						[0,0,0,4],
						[0,0,0,1]  
					];
		case null: 
		case 'null':
		case 'none':
		case '':
			return null;
		default:
			alert("errCode434 how did we get here:"+hiDimMode);  //bugbug perhaps the matrices should be attached to the <option elements???
	}

}







var mainBgColor='white';
function updateBackground(ev)
{
	mainBgColor = ($("#black").is(':checked')) ? 'black' : 'white';
}

var big=1;
function toggleBigness(ev)
{
	big=($("#big").is(':checked')) ? 2 : 1 ;
}



function parseDataSet(dataFileOptions,columnInfo)
{
	addCoordinateVectors(theDrawings);
	
	if (typeof getData != 'function') 
	{
		alert("dynamic read fail: cannot read the data type 1");  //bugbug make this an assert
		return theDrawings;	  // but you won't like it  
	}
	
	var textData=getData();	
	
	if (!textData) 
	{
		alert("cannot read the data type 2");  //bugbug make this an assert
		return theDrawings;
	}
	
	addTextData(theDrawings,textData,columnInfo,dataFileOptions,null);  //transformation function --- null=use the default
}





//used to track what keys are down
isDown = DemoUtils.KeyTracker.isDown

$(document).ready(function() 
{
	if (oGetVars["dataset"]) 
		$("#dataset").val(oGetVars["dataset"]);
		
	
	setMap(oGetVars["dataset"]);  
	updateBackground();
	
	StepperModule.Stepper.Create([
			function(){	start3d(theDrawings); },  //in cameraAndStuff.js
			function(){ finishGettingReady(); }
		]).run();

});


function finishGettingReady()
{
	anim = $("#animate");
	anim.click( function(event)
		{
			//turn on the animation
			DemoUtils.Notify("animate",animate.checked );
		});
	setTimeout(function()  //to avoid wasting CO2, we try to time out the animation...
		{
			anim.click();
		}
		,30*1000);//milliseconds  //bugbug settings		
	DemoUtils.Notify("animate",animate.checked );  //and do it once right now for good measure
	
	$("#xanimate").change( function(event)
		{
			changeXanimate(event);
		});
	

	$("#flyTo").click( function(event)
		{
			DemoUtils.Notify("flyToSelected","thisArgNotNeeded");		
		});
	
	$("#dataset").change( function(event)
		{
			changeDataSet(event);
		});
	$("#black").change( function(event)
		{
			updateBackground();
		});
	$("#big").change( function(event)
		{
			toggleBigness();
		});
};


</script>

</body>
</html>